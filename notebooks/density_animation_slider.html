<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cluster Density Animation with Slider</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    #controls {
      margin: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="viz"></div>
  <div id="controls">
    <input type="range" id="timeSlider" min="1" max="3" step="1" value="1">
    <label id="stageLabel">First Message Density</label>
    <button id="playButton">Play</button>
  </div>

  <script>
  // Example data for three stages
  const firstDensity = [
    { cluster: "1876", count: 40 },
    { cluster: "9620", count: 30 },
    { cluster: "7138", count: 20 },
    { cluster: "9778", count: 10 }
  ];

  const secondDensity = [
    { cluster: "1876", count: 25 },
    { cluster: "9620", count: 35 },
    { cluster: "7138", count: 15 },
    { cluster: "9778", count: 20 }
  ];

  const thirdDensity = [
    { cluster: "1876", count: 30 },
    { cluster: "9620", count: 20 },
    { cluster: "7138", count: 25 },
    { cluster: "9778", count: 15 }
  ];

  const clusterPositions = {
    "1876": { x: 150, y: 200 },
    "9620": { x: 300, y: 200 },
    "7138": { x: 450, y: 200 },
    "9778": { x: 600, y: 200 }
  };

  const width = 700, height = 400;
  const svg = d3.select("#viz").append("svg")
    .attr("width", width)
    .attr("height", height);

  const radiusScale = d3.scaleSqrt()
    .domain([0, d3.max(firstDensity.concat(secondDensity).concat(thirdDensity), d => d.count)])
    .range([10, 50]);

  const circles = svg.selectAll("circle")
    .data(firstDensity, d => d.cluster)
    .enter()
    .append("circle")
    .attr("cx", d => clusterPositions[d.cluster].x)
    .attr("cy", d => clusterPositions[d.cluster].y)
    .attr("r", d => radiusScale(d.count))
    .attr("fill", "steelblue")
    .attr("opacity", 0.7);

  svg.selectAll("text.cluster")
    .data(firstDensity, d => d.cluster)
    .enter()
    .append("text")
    .attr("class", "cluster")
    .attr("x", d => clusterPositions[d.cluster].x)
    .attr("y", d => clusterPositions[d.cluster].y + 5)
    .attr("text-anchor", "middle")
    .text(d => d.cluster)
    .style("font-size", "14px")
    .style("fill", "#333");

  const stageLabel = d3.select("#stageLabel");

  // Function to update based on stage
  function updateStage(stage) {
    let data, color, label;
    if (stage == 1) {
      data = firstDensity;
      color = "steelblue";
      label = "First Message Density";
    } else if (stage == 2) {
      data = secondDensity;
      color = "tomato";
      label = "Second Message Density";
    } else {
      data = thirdDensity;
      color = "green";
      label = "Third Message Density";
    }

    circles.data(data, d => d.cluster)
      .transition()
      .duration(1000)
      .attr("r", d => radiusScale(d.count))
      .attr("fill", color);

    stageLabel.text(label);
  }

  // Slider interaction
  document.getElementById("timeSlider").addEventListener("input", function() {
    const stage = +this.value;
    updateStage(stage);
  });

  // Play button interaction
  let currentStage = 1;
  let playing = false;
  let interval;

  document.getElementById("playButton").addEventListener("click", function() {
    if (!playing) {
      playing = true;
      this.textContent = "Pause";
      interval = setInterval(() => {
        currentStage = (currentStage % 3) + 1;
        document.getElementById("timeSlider").value = currentStage;
        updateStage(currentStage);
      }, 2000);
    } else {
      playing = false;
      this.textContent = "Play";
      clearInterval(interval);
    }
  });
  </script>
</body>
</html>
